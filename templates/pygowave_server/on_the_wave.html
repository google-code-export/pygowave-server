{% extends "base_transitional.html" %}
{% load i18n %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
{% load pgw_nav %}

{% block title %}{% trans "On the Wave" %}{% endblock %}
{% block nav %}{% pgw_navbar "waves" "on_the_wave" %}{% endblock %}
{% block additional_header %}
	<script type="text/javascript">
		// Cut to minimum to allow cross-subdomain access
		try {
			document.domain = document.domain.split('.').slice(1).join('.');
		}
		catch (e){
			document.domain = document.domain;
		}
	</script>
	<script type="text/javascript" src="http://{{ ORBITED_SERVER }}:{{ ORBITED_PORT }}/static/Orbited.js"></script>
	<script type="text/javascript">
		// --- Orbited configuration ---
		Orbited.settings.port = {{ ORBITED_PORT }};
		Orbited.settings.hostname = "{{ ORBITED_SERVER }}";
		Orbited.settings.log = true;
		Orbited.getLogger().enabled = true;
		TCPSocket = Orbited.TCPSocket;
	</script>
	<script type="text/javascript" src="http://{{ ORBITED_SERVER }}:{{ ORBITED_PORT }}/static/protocols/stomp/stomp.js"></script>
	<script type="text/javascript" src="{% url django.views.i18n.javascript_catalog %}"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}js/pycow.js"></script>
	<script type="text/javascript" src="{% url pygowave_server.views.pycow "model.js" %}"></script>
	<script type="text/javascript" src="{% url pygowave_server.views.pycow "operations.js" %}"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}js/pygowave-client-view.js"></script>
	<script type="text/javascript" src="{{ MEDIA_URL }}js/pygowave-client-controller.js"></script>
{% endblock %}

{% block content %}
<h1>{{ wavelet_title }}</h1>
<h4>{% trans "Hints" %}</h4>
<div class="section">
	<div id="leave_button" class="ui-state-default ui-corner-all">
		{% if LANGUAGE_BIDI %}<label>{% trans "Leave Wave" %}</label>{% endif %}
		<img src="{{ MEDIA_URL }}images/leave.png" height="22" width="22" alt="{% trans "Leave Wave" %}" />
		{% if not LANGUAGE_BIDI %}<label>{% trans "Leave Wave" %}</label>{% endif %}
	</div>
{% blocktrans %}
Some quick documentation: Click on the "+" to add a friend to your wave. The
search currently covers the whole database of users.<br/>
Any user can be added by everyone who participates in the wave. No one can
remove any other participant than him/herself. You can remove yourself from a
wave by clicking the "Leave Wave" button on the right hand side.<br/>
Again, this application is experimental and may not work as expected.
{% endblocktrans %}
</div>
<h4>{% trans "Playground" %}</h4>
<div class="section">
	<div id="wave_container">
		<!-- The content is dynamically rendered through our client script. -->
	</div>
	<script type="text/javascript">
		document.addEvent('domready', function () {
			model = new pygowave.model.WaveModel("{{ wave_id|escapejs }}", "{{ participant_id|escapejs }}");
			view = new pygowave.view.WaveView(
				model,
				$('wave_container'),
				{
					participantSearchUrl: "{% url pygowave_server.views.search_participants %}?q=",
					gadgetLoaderUrl: "{% url pygowave_server.views.gadget_loader %}?wave=1&",
					defaultThumbnailUrl: "{{ AVATAR_URL }}default.png"
				}
			);
			awavelet = model.createWavelet("demo", {
				is_root: true
			});
			me = new pygowave.model.Participant("nobody@localhost", {displayName: "nobody"});
			awavelet.addParticipant(me);
			//me.setOnline(true);
			
			theController = new pygowave.controller.PyGoWaveClient({
				// Random generated access keys
				waveAccessKeyTx: "{{ wave_access_key.tx }}",
				waveAccessKeyRx: "{{ wave_access_key.rx }}",
				
				initialWave: "{{ wave_id }}",
				initialWavelet: "{{ wavelet_id }}",
				viewerId: "{{ participant_id }}"
			});
			
			//theController.connect();
			
			theController.addEvent("waveletOpened", function (args) {
				ov = new pygowave.view.OperationsViewer(theController.wavelets[args.wavelet_id].mpending, theController.wavelets[args.wavelet_id].mcached);
			});
		});
	</script>
</div>
{% endblock %}
